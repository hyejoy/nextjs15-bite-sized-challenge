# Section 03-04.프리패칭

## 프리패칭

- 페이지를 사전에 미리 불러온다는 뜻
- 현재 사용자가 보고 있는 페이지중 링크를 통해 이동할 수 있는 모든 페이지를 사전에 다 불러와 놓는 기능
  ≒ 사용자가 보고 있는 페이지 내에서 이동할 수 있는 모든 페이지를 불러놓는 기능
- 페이지 이동을 매우 빠르게 처리 해주기 위해 사용

## 프리패칭이 가능한 이유

- Next.js에서 작성한 모든 JS 코드들(React Component들)을 자동으로 페이지별로 스플리팅 ≒ 페이지별로 분리
  해서 저장을 미리 해둠

## 프리패칭 사용 이유

- **`Next.js동작 과정`**
  -1.유저가 브라우저에서 페이지를 요청

  -2.서버에서 JavaScript 실행 및 렌더링
  \*Next.js 서버가 필요한 JavaScript를 실행하여 페이지 렌더링에 필요한 HTML을 생성함

  -3.렌더링된 HTML을 브라우저로 전달
  └──브라우저는 이 HTML을 그대로 화면에 렌더링함
  └──이 과정 덕분에 FCP(First Contentful Paint)가 빨라짐

  -4.초기 화면 렌더링 후, 아직 상호작용은 불가능
  └── 화면은 보이지만 JavaScript 로직이 연결되지 않은 상태
  └──버튼 클릭, 이벤트 처리 등 인터랙션은 아직 불가

  -5.JS 번들 전달 및 Hydration(수화) 진행
  └──서버가 후속으로 JS 번들 파일을 브라우저에 전달

  -6.브라우저가 JS 코드를 실행하여 이미 렌더링된 HTML과 React 컴포넌트를 연결함 (Hydration)

- Next.js에서 작성한 모든 JS 코드들(React Component들)을 자동으로 페이지별로 스플리팅 ≒ 페이지별로 분리
  해서 저장을 미리 해둠
- 첫 요청 시 서버에서 JS Bundle을 전달해 줄때 현재 페이지에 해당하는 JS코드들만 전달됨
  └── 자바스크립트 코드의 양을 줄이기 위해서
  └── 수화 과정을 빠르게 하기위해서 ≒ TTI 속도를 빠르게 하기 위해서

- 근데 이렇게 되면, 첫페이지 랜더링은 빠르게 된다해도,
  그외의 페이지로 이동할때 또 다시 서버에게 JS번들을 요청하는 과정을 반복해야됨

- ❕이 문제점을 해결하기 위해 **`프리패칭`**을 사용하는 것임

- 첫페이지 렌더링을 위해 해당 페이지에 필요한 JS번들을 불러온 다음
  바로 프리패칭을 발생시켜 현재페이지에서 이동할 수 있는 모든 페이지 JS번들을 불러온다.
  ![alt text](<image/03-04 프리패칭.png>)

## 프리패칭 동작 확인하기

- 참고로, 프리패칭은 개발 모드로 가동했을땐 작동하지 않음
- **`프로덕션`**모드로 실행하기

```bash
- npm run build
- npm run start
```

![alt text](<image/03-04 프리패칭_build결과.png>)

- 개발자도구 → Network → localhost:3000 접속 → 새로고침 → Network 탭 확인
  ![alt text](<image/03-04 프리패칭 확인.png>)
- search나 book페이지 이동시 Network보면 어떠한 요청도 발생하지 않음을 확인함

## 프리패칭 예외

- **`프로그래메틱`** 이동시에는 JS번들을 추가로 불러옴
  ≒ Link컴포넌트로 명시된 경로가 아니라면 프리패칭 이루어지지 않음

## 프로그래메틱 프리패칭 적용 방법

- router의 prefetch 함수를 useEffect에 등록

```ts
useEffect(() => {
  router.prefetch("/이동경로 작성");
}, []);
```

```ts
import { useRouter } from "next/router";
import { useEffect } from "react";
export default function App({ Component, pageProps }: AppProps) {
  const router = useRouter();

  const onClickButton = () => {
    router.push("/test");
  };

  /** App컴포넌트 첫 마운팅시 prefetch 적용 */
  useEffect(() => {
    router.prefetch("/test");
  }, []);

  return (
    <>
      <div>
        <button onClick={onClickButton}>/test 페이지이동</button>
      </div>
      <Component {...pageProps} />
    </>
  );
}
```

## Link 컴포넌트 프리패칭 기능 강제 해제 방법

- Link 컴포넌트의 prefetch 속성값 false로 설정

```ts
 <Link href={"/search"} prefetch={false}>
```
